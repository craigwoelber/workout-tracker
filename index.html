<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a192f">
    <title>Workout Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        html,body,#root{min-height:100vh;min-height:100dvh;background:#0a192f}
        body{font-family:'Outfit',system-ui,sans-serif;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
        input,select,button{font-family:inherit}
        input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
        input[type=number]{-moz-appearance:textfield}
        select option{background:#0a192f}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .fade-in{animation:fadeIn .3s ease-out}
    </style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHEET_ID = "14SjL6EHtrmGMF84Y2mIQs-ZUPoeYSh_VQNfi-I1ukhQ";
const WEEKS = ["WEEK 1","WEEK 2","WEEK 3","WEEK 4","WEEK 5","WEEK 6","WEEK 7","WEEK 8","DELOAD"];
const DB_NAME = "WorkoutTrackerDB";
const DB_VERSION = 1;

// ExerciseDB API
const EXERCISEDB_HOST = "exercisedb.p.rapidapi.com";
const EXERCISEDB_KEY = "6053294d2cmsh784416a9d0bf043p1c1eecjsn4b4efb735ed8";
const EXERCISEDB_HEADERS = { "X-RapidAPI-Key": EXERCISEDB_KEY, "X-RapidAPI-Host": EXERCISEDB_HOST };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IndexedDB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains("kv")) db.createObjectStore("kv");
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbGet(key) {
  const db = await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction("kv", "readonly");
    const req = tx.objectStore("kv").get(key);
    req.onsuccess = () => resolve(req.result ?? null);
    req.onerror = () => resolve(null);
  });
}

async function dbSet(key, val) {
  const db = await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction("kv", "readwrite");
    tx.objectStore("kv").put(val, key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => resolve();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Google Sheets Fetcher
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseGviz(text) {
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
  return json.table.rows.map(r => r.c.map(c => (c && c.v != null) ? String(c.v) : ""));
}

function parseWeek(rows, weekName) {
  const days = [];
  // Day 1 header is in merged cells that gviz skips
  let currentDay = { name: "DAY 1 - PULL #1", exercises: [] };
  for (const row of rows) {
    const a = (row[0] || "").trim();
    if (/^DAY\s+\d+/i.test(a)) {
      if (currentDay?.exercises.length > 0) days.push(currentDay);
      currentDay = { name: a, exercises: [] };
      continue;
    }
    if (!a || a === "EXERCISE" || /fitnessfaq/i.test(a)) continue;
    if (currentDay) {
      currentDay.exercises.push({
        name: a,
        sets: parseInt(row[1]) || 3,
        reps: (row[2] || "").trim(),
        rest: (row[3] || "2").trim()
      });
    }
  }
  if (currentDay?.exercises.length > 0) days.push(currentDay);
  return days;
}

async function fetchAllWeeks() {
  const allData = {};
  const fetches = WEEKS.map(async (week) => {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(week)}&range=A1:H70`;
    const resp = await fetch(url);
    const text = await resp.text();
    allData[week] = parseWeek(parseGviz(text), week);
  });
  await Promise.all(fetches);
  return allData;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ExerciseDB API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function searchExercises(query) {
  const resp = await fetch(
    `https://${EXERCISEDB_HOST}/exercises/name/${encodeURIComponent(query.toLowerCase())}?limit=100&offset=0`,
    { headers: EXERCISEDB_HEADERS }
  );
  if (!resp.ok) throw new Error("API request failed");
  return resp.json();
}

async function fetchBodyPartList() {
  const resp = await fetch(`https://${EXERCISEDB_HOST}/exercises/bodyPartList`, { headers: EXERCISEDB_HEADERS });
  if (!resp.ok) throw new Error("API request failed");
  return resp.json();
}

async function fetchByBodyPart(bodyPart) {
  const resp = await fetch(
    `https://${EXERCISEDB_HOST}/exercises/bodyPart/${encodeURIComponent(bodyPart)}?limit=100&offset=0`,
    { headers: EXERCISEDB_HEADERS }
  );
  if (!resp.ok) throw new Error("API request failed");
  return resp.json();
}

async function fetchByEquipment(equipment) {
  const resp = await fetch(
    `https://${EXERCISEDB_HOST}/exercises/equipment/${encodeURIComponent(equipment)}?limit=100&offset=0`,
    { headers: EXERCISEDB_HEADERS }
  );
  if (!resp.ok) throw new Error("API request failed");
  return resp.json();
}

async function fetchEquipmentList() {
  const resp = await fetch(`https://${EXERCISEDB_HOST}/exercises/equipmentList`, { headers: EXERCISEDB_HEADERS });
  if (!resp.ok) throw new Error("API request failed");
  return resp.json();
}

function exerciseImageUrl(id) {
  return `https://${EXERCISEDB_HOST}/image?exerciseId=${id}&resolution=180`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Notifications & Audio
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function playBeep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const beep = (freq, start, dur) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = "sine";
      gain.gain.setValueAtTime(0.3, ctx.currentTime + start);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + start + dur);
      osc.start(ctx.currentTime + start);
      osc.stop(ctx.currentTime + start + dur);
    };
    beep(830, 0, 0.15);
    beep(830, 0.2, 0.15);
    beep(1100, 0.4, 0.3);
  } catch (e) {}
}

function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
}

function sendTimerNotification() {
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification("Rest Complete", { body: "Time for your next set!", icon: "icon-192.png", tag: "rest-timer" });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Components
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ Rest Timer ‚îÄ‚îÄ‚îÄ
function RestTimer({ duration, onComplete, onCancel }) {
  const [remaining, setRemaining] = useState(duration);
  const startRef = useRef(Date.now());

  useEffect(() => {
    startRef.current = Date.now();
    const iv = setInterval(() => {
      const left = Math.max(0, duration - Math.floor((Date.now() - startRef.current) / 1000));
      setRemaining(left);
      if (left <= 0) {
        clearInterval(iv);
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        playBeep();
        sendTimerNotification();
        onComplete();
      }
    }, 250);
    return () => clearInterval(iv);
  }, [duration, onComplete]);

  const mins = Math.floor(remaining / 60);
  const secs = remaining % 60;
  const progress = 1 - remaining / duration;
  const circumference = 2 * Math.PI * 54;
  const strokeDashoffset = circumference * (1 - progress);

  return (
    <div className="fade-in" style={{
      background: "linear-gradient(135deg,#1a1a2e,#16213e)", borderRadius: 20,
      padding: "32px 24px", textAlign: "center", border: "2px solid #e94560",
      position: "relative", overflow: "hidden"
    }}>
      <div style={{ position: "absolute", top: 0, left: 0, height: "100%",
        width: `${progress * 100}%`, background: "rgba(233,69,96,0.1)",
        transition: "width 0.25s linear" }} />
      <div style={{ position: "relative", zIndex: 1 }}>
        {/* Circular progress */}
        <div style={{ position: "relative", width: 140, height: 140, margin: "0 auto 16px" }}>
          <svg width="140" height="140" style={{ transform: "rotate(-90deg)" }}>
            <circle cx="70" cy="70" r="54" fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="8" />
            <circle cx="70" cy="70" r="54" fill="none" stroke="#e94560" strokeWidth="8"
              strokeLinecap="round" strokeDasharray={circumference}
              strokeDashoffset={strokeDashoffset}
              style={{ transition: "stroke-dashoffset 0.25s linear" }} />
          </svg>
          <div style={{
            position: "absolute", top: "50%", left: "50%", transform: "translate(-50%,-50%)",
            fontFamily: "'JetBrains Mono',monospace", fontSize: 36, fontWeight: 700,
            color: "#e94560", letterSpacing: 2
          }}>
            {mins}:{secs.toString().padStart(2, "0")}
          </div>
        </div>
        <div style={{ color: "#8892b0", fontSize: 12, letterSpacing: 2, textTransform: "uppercase", marginBottom: 16 }}>
          Rest Timer
        </div>
        <button onClick={onCancel} style={{
          background: "rgba(255,255,255,0.08)", border: "1px solid rgba(255,255,255,0.15)",
          color: "#ccd6f6", padding: "12px 32px", borderRadius: 12, fontSize: 15,
          cursor: "pointer", fontWeight: 600, letterSpacing: 1
        }}>Skip ‚Üí</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Set Input ‚îÄ‚îÄ‚îÄ
function SetInput({ setNumber, onSubmit, exercise, lastEntry }) {
  const parsed = lastEntry ? lastEntry.split("√ó") : null;
  const prevWeight = parsed && parsed[0] !== "BW" ? parsed[0] : "";
  const prevReps = parsed ? parsed[1] : "";

  const [weight, setWeight] = useState(prevWeight);
  const [reps, setReps] = useState(prevReps);
  const weightRef = useRef(null);

  useEffect(() => {
    const p = lastEntry ? lastEntry.split("√ó") : null;
    setWeight(p && p[0] !== "BW" ? p[0] : "");
    setReps(p ? p[1] : "");
    setTimeout(() => weightRef.current?.focus(), 100);
  }, [setNumber, lastEntry]);

  const handleSubmit = () => {
    if (!reps) return;
    onSubmit(weight ? `${weight}√ó${reps}` : `BW√ó${reps}`);
  };

  const inp = {
    width: "100%", padding: "16px 12px", background: "rgba(255,255,255,0.06)",
    border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12,
    color: "#ccd6f6", fontSize: 22, fontWeight: 600, textAlign: "center",
    outline: "none", fontFamily: "'JetBrains Mono',monospace"
  };

  return (
    <div className="fade-in" style={{
      background: "linear-gradient(135deg,#0f3460,#16213e)", borderRadius: 16,
      padding: 20, border: "1px solid rgba(233,69,96,0.3)"
    }}>
      <div style={{ color: "#e94560", fontWeight: 700, fontSize: 13, letterSpacing: 2, textTransform: "uppercase", marginBottom: 16 }}>
        Set {setNumber} of {exercise.sets}
      </div>
      <div style={{ display: "flex", gap: 10, alignItems: "flex-end" }}>
        <div style={{ flex: 1 }}>
          <label style={{ display: "block", color: "#8892b0", fontSize: 11, marginBottom: 6, letterSpacing: 1, textTransform: "uppercase" }}>Weight</label>
          <input ref={weightRef} type="number" inputMode="decimal" value={weight}
            onChange={e => setWeight(e.target.value)} placeholder="BW"
            onKeyDown={e => e.key === "Enter" && document.getElementById("reps-input")?.focus()}
            style={inp} />
        </div>
        <div style={{ flex: 1 }}>
          <label style={{ display: "block", color: "#8892b0", fontSize: 11, marginBottom: 6, letterSpacing: 1, textTransform: "uppercase" }}>Reps</label>
          <input id="reps-input" type="number" inputMode="numeric" value={reps}
            onChange={e => setReps(e.target.value)} placeholder="0"
            onKeyDown={e => e.key === "Enter" && handleSubmit()} style={inp} />
        </div>
        <button onClick={handleSubmit} style={{
          padding: "16px 20px", background: "#e94560", border: "none", borderRadius: 12,
          color: "white", fontSize: 18, fontWeight: 700, cursor: "pointer",
          whiteSpace: "nowrap", minHeight: 58
        }}>Log ‚úì</button>
      </div>
      <div style={{ color: "#8892b0", fontSize: 13, marginTop: 12, textAlign: "center" }}>
        Target: <span style={{ color: "#64ffda", fontWeight: 700 }}>{exercise.reps}</span> reps
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Edit Set Inline ‚îÄ‚îÄ‚îÄ
function EditSetInput({ setIndex, entry, onSave, onCancel }) {
  const parsed = entry.split("√ó");
  const isBW = parsed[0] === "BW";
  const [weight, setWeight] = useState(isBW ? "" : parsed[0]);
  const [reps, setReps] = useState(parsed[1] || "");
  const weightRef = useRef(null);

  useEffect(() => { setTimeout(() => weightRef.current?.focus(), 50); }, []);

  const handleSave = () => {
    if (!reps) return;
    onSave(weight ? `${weight}√ó${reps}` : `BW√ó${reps}`);
  };

  const inp = {
    width: "100%", padding: "10px 8px", background: "rgba(255,255,255,0.08)",
    border: "2px solid #e94560", borderRadius: 8,
    color: "#ccd6f6", fontSize: 18, fontWeight: 600, textAlign: "center",
    outline: "none", fontFamily: "'JetBrains Mono',monospace"
  };

  return (
    <div className="fade-in" style={{
      background: "rgba(233,69,96,0.08)", border: "1px solid rgba(233,69,96,0.3)",
      borderRadius: 10, padding: 10, minWidth: 200
    }}>
      <div style={{ color: "#e94560", fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", marginBottom: 6 }}>
        Editing Set {setIndex + 1}
      </div>
      <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
        <input ref={weightRef} type="number" inputMode="decimal" value={weight}
          onChange={e => setWeight(e.target.value)} placeholder="BW"
          onKeyDown={e => e.key === "Enter" && document.getElementById(`edit-reps-${setIndex}`)?.focus()}
          style={{ ...inp, flex: 1 }} />
        <span style={{ color: "#8892b0", fontSize: 16 }}>√ó</span>
        <input id={`edit-reps-${setIndex}`} type="number" inputMode="numeric" value={reps}
          onChange={e => setReps(e.target.value)} placeholder="0"
          onKeyDown={e => e.key === "Enter" && handleSave()}
          style={{ ...inp, flex: 1 }} />
      </div>
      <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
        <button onClick={onCancel} style={{
          flex: 1, padding: "8px 0", background: "rgba(255,255,255,0.06)", border: "1px solid rgba(255,255,255,0.15)",
          borderRadius: 8, color: "#8892b0", fontSize: 13, cursor: "pointer", fontWeight: 600
        }}>Cancel</button>
        <button onClick={handleSave} style={{
          flex: 1, padding: "8px 0", background: "#e94560", border: "none",
          borderRadius: 8, color: "white", fontSize: 13, cursor: "pointer", fontWeight: 600
        }}>Save</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Exercise History ‚îÄ‚îÄ‚îÄ
function ExerciseHistory({ history }) {
  if (!history || history.length === 0) return null;
  return (
    <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 12, padding: "12px 16px", marginTop: 14 }}>
      <div style={{ color: "#64ffda", fontSize: 11, fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 8 }}>
        Previous Sessions
      </div>
      {history.slice(-5).map((h, i) => (
        <div key={i} style={{
          display: "flex", justifyContent: "space-between", alignItems: "center",
          padding: "7px 0", borderBottom: i < Math.min(history.length, 5) - 1 ? "1px solid rgba(255,255,255,0.06)" : "none"
        }}>
          <span style={{ color: "#8892b0", fontSize: 12 }}>{h.week} D{h.day + 1}</span>
          <span style={{ color: "#ccd6f6", fontSize: 13, fontFamily: "'JetBrains Mono',monospace" }}>{h.sets.join(" / ")}</span>
        </div>
      ))}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Exercise Progress Chart ‚îÄ‚îÄ‚îÄ
function ExerciseChart({ history }) {
  if (!history || history.length < 2) return null;

  // Parse sessions: max weight per session, avg reps per session
  const sessions = history.map(h => {
    let maxWeight = 0;
    let totalReps = 0;
    let repCount = 0;
    let allBW = true;
    for (const s of h.sets) {
      const parts = s.split("√ó");
      if (parts[0] !== "BW") {
        const w = parseFloat(parts[0]) || 0;
        if (w > maxWeight) maxWeight = w;
        allBW = false;
      }
      totalReps += parseInt(parts[1]) || 0;
      repCount++;
    }
    return {
      label: h.week.replace("WEEK ", "W") + " D" + (h.day + 1),
      weight: allBW ? null : maxWeight,
      reps: repCount > 0 ? Math.round(totalReps / repCount) : 0
    };
  });

  const hasWeight = sessions.some(s => s.weight !== null);
  const weights = sessions.map(s => s.weight).filter(w => w !== null);
  const repsArr = sessions.map(s => s.reps);

  const wMin = hasWeight ? Math.min(...weights) : 0;
  const wMax = hasWeight ? Math.max(...weights) : 0;
  const rMin = Math.min(...repsArr);
  const rMax = Math.max(...repsArr);

  // Chart dimensions
  const W = 380, H = 160, padL = 40, padR = 36, padT = 10, padB = 28;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const xStep = sessions.length > 1 ? plotW / (sessions.length - 1) : 0;
  const x = (i) => padL + i * xStep;

  // Scale functions with small buffer so lines don't sit on edges
  const scaleW = (v) => {
    if (wMax === wMin) return padT + plotH / 2;
    return padT + plotH - ((v - wMin) / (wMax - wMin)) * plotH;
  };
  const scaleR = (v) => {
    if (rMax === rMin) return padT + plotH / 2;
    return padT + plotH - ((v - rMin) / (rMax - rMin)) * plotH;
  };

  const polyline = (pts) => pts.map(([px, py]) => `${px},${py}`).join(" ");

  const weightPts = hasWeight ? sessions.map((s, i) => s.weight !== null ? [x(i), scaleW(s.weight)] : null).filter(Boolean) : [];
  const repsPts = sessions.map((s, i) => [x(i), scaleR(s.reps)]);

  return (
    <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 12, padding: "12px 16px", marginTop: 14 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
        <div style={{ color: "#8892b0", fontSize: 11, fontWeight: 700, letterSpacing: 2, textTransform: "uppercase" }}>Progress</div>
        <div style={{ display: "flex", gap: 12 }}>
          {hasWeight && <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <div style={{ width: 10, height: 3, background: "#e94560", borderRadius: 2 }} />
            <span style={{ color: "#8892b0", fontSize: 10 }}>Weight</span>
          </div>}
          <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
            <div style={{ width: 10, height: 3, background: "#64ffda", borderRadius: 2 }} />
            <span style={{ color: "#8892b0", fontSize: 10 }}>Reps</span>
          </div>
        </div>
      </div>
      <svg viewBox={`0 0 ${W} ${H}`} style={{ width: "100%", height: "auto" }}>
        {/* Grid lines */}
        {[0, 0.5, 1].map(f => (
          <line key={f} x1={padL} y1={padT + plotH * (1 - f)} x2={W - padR} y2={padT + plotH * (1 - f)}
            stroke="rgba(255,255,255,0.06)" strokeWidth="1" />
        ))}
        {/* Y-axis labels: weight left, reps right */}
        {hasWeight && [wMin, wMax].map((v, i) => (
          <text key={`w${i}`} x={padL - 6} y={i === 0 ? padT + plotH + 4 : padT + 4}
            fill="#e94560" fontSize="9" textAnchor="end" fontFamily="'JetBrains Mono',monospace">{Math.round(v)}</text>
        ))}
        {[rMin, rMax].map((v, i) => (
          <text key={`r${i}`} x={W - padR + 6} y={i === 0 ? padT + plotH + 4 : padT + 4}
            fill="#64ffda" fontSize="9" textAnchor="start" fontFamily="'JetBrains Mono',monospace">{Math.round(v)}</text>
        ))}
        {/* X-axis labels */}
        {sessions.map((s, i) => (
          <text key={i} x={x(i)} y={H - 4} fill="#8892b0" fontSize="8" textAnchor="middle"
            fontFamily="'JetBrains Mono',monospace">{s.label}</text>
        ))}
        {/* Weight line */}
        {hasWeight && weightPts.length > 1 && (
          <React.Fragment>
            <polyline points={polyline(weightPts)} fill="none" stroke="#e94560" strokeWidth="2.5" strokeLinejoin="round" strokeLinecap="round" />
            {weightPts.map(([px, py], i) => (
              <circle key={i} cx={px} cy={py} r="4" fill="#e94560" />
            ))}
          </React.Fragment>
        )}
        {/* Reps line */}
        {repsPts.length > 1 && (
          <React.Fragment>
            <polyline points={polyline(repsPts)} fill="none" stroke="#64ffda" strokeWidth="2.5" strokeLinejoin="round" strokeLinecap="round" />
            {repsPts.map(([px, py], i) => (
              <circle key={i} cx={px} cy={py} r="4" fill="#64ffda" />
            ))}
          </React.Fragment>
        )}
      </svg>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Pill badge ‚îÄ‚îÄ‚îÄ
function Pill({ color, label, value }) {
  const bg = color === "green" ? "rgba(100,255,218,0.1)" : color === "red" ? "rgba(233,69,96,0.1)" : "rgba(255,255,255,0.06)";
  const fg = color === "green" ? "#64ffda" : color === "red" ? "#e94560" : "#ccd6f6";
  return (
    <div style={{ background: bg, borderRadius: 8, padding: "6px 14px", display: "inline-flex", alignItems: "center", gap: 6 }}>
      <span style={{ color: fg, fontSize: 13, fontWeight: 700 }}>{value}</span>
      <span style={{ color: "#8892b0", fontSize: 11 }}>{label}</span>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ‚îÄ
function BottomNav({ tab, onTabChange }) {
  const tabStyle = (active) => ({
    flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 4,
    padding: "10px 0 8px", background: "none", border: "none",
    color: active ? "#64ffda" : "#8892b0", fontSize: 11, fontWeight: 600,
    cursor: "pointer", letterSpacing: 1, textTransform: "uppercase",
    borderTop: active ? "2px solid #64ffda" : "2px solid transparent",
    transition: "all 0.2s ease"
  });
  return (
    <div style={{
      position: "fixed", bottom: 0, left: 0, right: 0,
      background: "#0a192f", borderTop: "1px solid rgba(255,255,255,0.08)",
      display: "flex", maxWidth: 480, margin: "0 auto", zIndex: 100
    }}>
      <button onClick={() => onTabChange("workout")} style={tabStyle(tab === "workout")}>
        <span style={{ fontSize: 20 }}>üèãÔ∏è</span>
        Workout
      </button>
      <button onClick={() => onTabChange("build")} style={tabStyle(tab === "build")}>
        <span style={{ fontSize: 20 }}>üîß</span>
        Build
      </button>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Exercise Image (fetches with API key headers) ‚îÄ‚îÄ‚îÄ
const gifCache = {};
function ExerciseGif({ exerciseId, size }) {
  const [src, setSrc] = useState(gifCache[exerciseId] || null);
  useEffect(() => {
    if (!exerciseId || gifCache[exerciseId]) return;
    let cancelled = false;
    fetch(exerciseImageUrl(exerciseId), { headers: EXERCISEDB_HEADERS })
      .then(r => r.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        gifCache[exerciseId] = url;
        if (!cancelled) setSrc(url);
      })
      .catch(() => {});
    return () => { cancelled = true; };
  }, [exerciseId]);

  const s = size || 56;
  if (!src) return (
    <div style={{ width: s, height: s, borderRadius: 10, flexShrink: 0, background: "rgba(255,255,255,0.06)", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ width: 16, height: 16, border: "2px solid #64ffda", borderTopColor: "transparent", borderRadius: "50%", animation: "pulse 0.8s linear infinite" }} />
    </div>
  );
  return <img src={src} alt="" style={{ width: s, height: s, borderRadius: 10, objectFit: "cover", background: "rgba(255,255,255,0.06)", flexShrink: 0 }} />;
}

// ‚îÄ‚îÄ‚îÄ Exercise Search ‚îÄ‚îÄ‚îÄ
function ExerciseSearch({ onSelect, onBack }) {
  const [query, setQuery] = useState("");
  const [results, setResults] = useState([]);
  const [bodyParts, setBodyParts] = useState([]);
  const [selectedPart, setSelectedPart] = useState(null);
  const [selectedEquipment, setSelectedEquipment] = useState(null);
  const [searching, setSearching] = useState(false);
  const [error, setError] = useState(null);
  const [expanded, setExpanded] = useState(null);
  const [equipmentList, setEquipmentList] = useState([]);
  const searchTimer = useRef(null);

  // Load body part + equipment lists on mount
  useEffect(() => {
    fetchBodyPartList().then(setBodyParts).catch(err => console.error("Failed to load body parts:", err));
    fetchEquipmentList().then(list => {
      console.log("Equipment list loaded:", list.length, "items");
      setEquipmentList(list);
    }).catch(err => console.error("Failed to load equipment list:", err));
  }, []);

  // Unified fetch: triggers when query, selectedPart, or selectedEquipment changes
  useEffect(() => {
    if (searchTimer.current) clearTimeout(searchTimer.current);
    const hasFilter = query.trim() || selectedPart || selectedEquipment;
    if (!hasFilter) { setResults([]); return; }

    searchTimer.current = setTimeout(async () => {
      setSearching(true); setError(null); setExpanded(null);
      try {
        let data;
        // Strategy: When filters are active, fetch by filter (more complete results), then search client-side
        // This avoids missing exercises due to search API's 20-result limit
        if (selectedPart || selectedEquipment) {
          // Filters active: fetch by most restrictive filter, then search/filter client-side
          if (selectedPart && selectedEquipment) {
            data = await fetchByBodyPart(selectedPart); // Usually smaller set
          } else if (selectedPart) {
            data = await fetchByBodyPart(selectedPart);
          } else {
            data = await fetchByEquipment(selectedEquipment);
          }
          // Client-side filters
          if (selectedEquipment && selectedPart) data = data.filter(ex => ex.equipment === selectedEquipment);
          if (query.trim()) {
            const q = query.trim().toLowerCase();
            data = data.filter(ex => ex.name.toLowerCase().includes(q));
          }
        } else if (query.trim()) {
          // No filters: use search API
          data = await searchExercises(query.trim());
        } else {
          data = [];
        }
        setResults(data);
      } catch (e) { setError("Search failed. Check your connection."); }
      setSearching(false);
    }, query.trim() ? 500 : 0);
    return () => clearTimeout(searchTimer.current);
  }, [query, selectedPart, selectedEquipment]);

  const handleBodyPart = (part) => {
    setSelectedPart(selectedPart === part ? null : part);
    setQuery("");
  };

  const handleEquipment = (eq) => {
    setSelectedEquipment(selectedEquipment === eq ? null : eq);
    setQuery("");
  };

  return (
    <div style={{ padding: "0 20px 80px" }}>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 20 }}>
        {onBack && <button onClick={onBack} style={{ background: "none", border: "none", color: "#64ffda", fontSize: 15, cursor: "pointer", fontWeight: 600, flexShrink: 0 }}>‚Üê</button>}
        <input
          type="text" value={query} onChange={e => setQuery(e.target.value)}
          placeholder="Search exercises..."
          style={{
            flex: 1, padding: "14px 16px", background: "rgba(255,255,255,0.06)",
            border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12,
            color: "#ccd6f6", fontSize: 16, outline: "none"
          }}
        />
      </div>

      {/* Filters Section Header */}
      <div style={{ marginBottom: 20, paddingTop: 8, borderTop: "1px solid rgba(255,255,255,0.06)" }}>
        <div style={{ color: "#64ffda", fontSize: 13, fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 16 }}>
          Filters
        </div>

        {/* Body part chips */}
        <div style={{ marginBottom: 20 }}>
          <div style={{ color: "#ccd6f6", fontSize: 12, fontWeight: 600, marginBottom: 10, display: "flex", alignItems: "center", gap: 8 }}>
            <span>Body Part</span>
            {bodyParts.length > 0 && <span style={{ color: "#8892b0", fontSize: 11 }}>({bodyParts.length})</span>}
          </div>
          <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
            {bodyParts.map(part => (
              <button key={part} onClick={() => handleBodyPart(part)} style={{
                padding: "6px 12px", borderRadius: 16, fontSize: 11, fontWeight: 600,
                textTransform: "capitalize", cursor: "pointer", border: "none",
                background: selectedPart === part ? "#64ffda" : "rgba(255,255,255,0.06)",
                color: selectedPart === part ? "#0a192f" : "#ccd6f6",
                transition: "all 0.2s ease"
              }}>{part}</button>
            ))}
          </div>
        </div>

        {/* Equipment chips */}
        {equipmentList.length > 0 && (
          <div style={{ marginBottom: 20 }}>
            <div style={{ color: "#ccd6f6", fontSize: 12, fontWeight: 600, marginBottom: 10, display: "flex", alignItems: "center", gap: 8 }}>
              <span>Equipment</span>
              <span style={{ color: "#8892b0", fontSize: 11 }}>({equipmentList.length})</span>
            </div>
            <div style={{
              display: "flex", gap: 6, flexWrap: "wrap",
              maxHeight: "200px", overflowY: "auto",
              padding: "4px", marginRight: "-4px"
            }}>
              {equipmentList.map(eq => (
                <button key={eq} onClick={() => handleEquipment(eq)} style={{
                  padding: "6px 12px", borderRadius: 16, fontSize: 11, fontWeight: 600,
                  cursor: "pointer", border: "none", textTransform: "capitalize",
                  background: selectedEquipment === eq ? "#e94560" : "rgba(255,255,255,0.06)",
                  color: selectedEquipment === eq ? "#fff" : "#ccd6f6",
                  transition: "all 0.2s ease", flexShrink: 0
                }}>{eq}</button>
              ))}
            </div>
          </div>
        )}
      </div>

      {searching && (
        <div style={{ textAlign: "center", padding: 32, color: "#8892b0", fontSize: 13, letterSpacing: 2, animation: "pulse 1.5s infinite" }}>
          SEARCHING...
        </div>
      )}
      {error && <div style={{ textAlign: "center", padding: 24, color: "#e94560", fontSize: 14 }}>{error}</div>}

      {/* Results */}
      {results.map((ex, i) => (
        <div key={ex.id || i} className="fade-in" style={{
          background: "rgba(255,255,255,0.04)", borderRadius: 14,
          marginBottom: 12, border: "1px solid rgba(255,255,255,0.06)",
          overflow: "hidden", animationDelay: `${i * 30}ms`
        }}>
          <div onClick={() => setExpanded(expanded === i ? null : i)} style={{
            display: "flex", alignItems: "center", gap: 14, padding: 14, cursor: "pointer"
          }}>
            <ExerciseGif exerciseId={ex.id} size={56} />
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ color: "#ccd6f6", fontSize: 15, fontWeight: 600, textTransform: "capitalize", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                {ex.name}
              </div>
              <div style={{ color: "#8892b0", fontSize: 12, marginTop: 3, textTransform: "capitalize" }}>
                {ex.bodyPart} ¬∑ {ex.target} ¬∑ {ex.equipment}
              </div>
            </div>
            {onSelect && (
              <button onClick={(e) => { e.stopPropagation(); onSelect(ex); }} style={{
                padding: "8px 14px", background: "rgba(100,255,218,0.15)",
                border: "1px solid rgba(100,255,218,0.3)", borderRadius: 10,
                color: "#64ffda", fontSize: 13, fontWeight: 700, cursor: "pointer", flexShrink: 0
              }}>+ Add</button>
            )}
          </div>

          {/* Expanded details */}
          {expanded === i && (
            <div style={{ padding: "0 14px 14px", borderTop: "1px solid rgba(255,255,255,0.06)" }}>
              <div style={{ display: "flex", justifyContent: "center", paddingTop: 14, marginBottom: 14 }}>
                <ExerciseGif exerciseId={ex.id} size={180} />
              </div>
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap", marginBottom: 10 }}>
                <div style={{ background: "rgba(100,255,218,0.08)", borderRadius: 8, padding: "8px 14px" }}>
                  <div style={{ color: "#64ffda", fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", marginBottom: 2 }}>Target</div>
                  <div style={{ color: "#ccd6f6", fontSize: 13, textTransform: "capitalize" }}>{ex.target}</div>
                </div>
                <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 8, padding: "8px 14px" }}>
                  <div style={{ color: "#64ffda", fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", marginBottom: 2 }}>Equipment</div>
                  <div style={{ color: "#ccd6f6", fontSize: 13, textTransform: "capitalize" }}>{ex.equipment}</div>
                </div>
                {ex.difficulty && (
                  <div style={{ background: "rgba(233,69,96,0.08)", borderRadius: 8, padding: "8px 14px" }}>
                    <div style={{ color: "#e94560", fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", marginBottom: 2 }}>Difficulty</div>
                    <div style={{ color: "#ccd6f6", fontSize: 13, textTransform: "capitalize" }}>{ex.difficulty}</div>
                  </div>
                )}
              </div>
              {ex.secondaryMuscles?.length > 0 && (
                <div style={{ marginBottom: 10 }}>
                  <div style={{ color: "#8892b0", fontSize: 11, letterSpacing: 1, textTransform: "uppercase", marginBottom: 4 }}>Secondary Muscles</div>
                  <div style={{ color: "#ccd6f6", fontSize: 13, textTransform: "capitalize" }}>{ex.secondaryMuscles.join(", ")}</div>
                </div>
              )}
              {ex.instructions?.length > 0 && (
                <div style={{ marginTop: 10 }}>
                  <div style={{ color: "#64ffda", fontSize: 10, fontWeight: 700, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Instructions</div>
                  {ex.instructions.map((step, si) => (
                    <div key={si} style={{ color: "#ccd6f6", fontSize: 13, lineHeight: 1.5, marginBottom: 6, paddingLeft: 16, position: "relative" }}>
                      <span style={{ position: "absolute", left: 0, color: "#8892b0", fontSize: 12 }}>{si + 1}.</span>
                      {step}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      ))}

      {!searching && !error && results.length === 0 && (query || selectedPart || selectedEquipment) && (
        <div style={{ textAlign: "center", padding: 32, color: "#8892b0", fontSize: 14 }}>
          No exercises found
        </div>
      )}
      {!searching && !query && !selectedPart && !selectedEquipment && results.length === 0 && (
        <div style={{ textAlign: "center", padding: 32, color: "#8892b0", fontSize: 14, lineHeight: 1.6 }}>
          Search by name, or select a body part or equipment type
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Builder Home ‚îÄ‚îÄ‚îÄ
function BuilderHome({ routines, programs, onNewRoutine, onEditRoutine, onDeleteRoutine, onNewProgram, onEditProgram, onDeleteProgram, onActivateProgram, activeSource, onSearch }) {
  return (
    <div style={{ padding: "0 20px 80px" }}>
      {/* Search shortcut */}
      <button onClick={onSearch} style={{
        width: "100%", padding: "16px 20px", background: "rgba(255,255,255,0.04)",
        border: "2px dashed rgba(255,255,255,0.12)", borderRadius: 14,
        color: "#8892b0", fontSize: 15, cursor: "pointer", textAlign: "left",
        marginBottom: 28, display: "flex", alignItems: "center", gap: 10
      }}>
        <span style={{ fontSize: 18 }}>üîç</span> Search exercises...
      </button>

      {/* Routines section */}
      <div style={{ marginBottom: 32 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
          <h3 style={{ color: "#ccd6f6", fontSize: 18, fontWeight: 700 }}>My Routines</h3>
          <button onClick={onNewRoutine} style={{
            padding: "8px 16px", background: "rgba(100,255,218,0.15)",
            border: "1px solid rgba(100,255,218,0.3)", borderRadius: 10,
            color: "#64ffda", fontSize: 13, fontWeight: 700, cursor: "pointer"
          }}>+ New</button>
        </div>

        {Object.values(routines).length === 0 ? (
          <div style={{ padding: 24, textAlign: "center", color: "#8892b0", fontSize: 14, background: "rgba(255,255,255,0.02)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.06)" }}>
            No routines yet. Create one to get started!
          </div>
        ) : (
          Object.values(routines).map(routine => (
            <div key={routine.id} className="fade-in" style={{
              background: "rgba(255,255,255,0.04)", borderRadius: 14,
              padding: 16, marginBottom: 10, border: "1px solid rgba(255,255,255,0.06)"
            }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ color: "#ccd6f6", fontSize: 16, fontWeight: 600 }}>{routine.name}</div>
                  <div style={{ color: "#8892b0", fontSize: 13, marginTop: 4 }}>{routine.exercises.length} exercises</div>
                  <div style={{ color: "#8892b0", fontSize: 12, marginTop: 4, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                    {routine.exercises.map(e => e.name).join(", ")}
                  </div>
                </div>
                <div style={{ display: "flex", gap: 8, flexShrink: 0, marginLeft: 12 }}>
                  <button onClick={() => onEditRoutine(routine.id)} style={{
                    padding: "8px 12px", background: "rgba(255,255,255,0.06)",
                    border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8,
                    color: "#8892b0", fontSize: 12, cursor: "pointer"
                  }}>Edit</button>
                  <button onClick={() => { if (confirm(`Delete "${routine.name}"?`)) onDeleteRoutine(routine.id); }} style={{
                    padding: "8px 12px", background: "rgba(233,69,96,0.1)",
                    border: "1px solid rgba(233,69,96,0.2)", borderRadius: 8,
                    color: "#e94560", fontSize: 12, cursor: "pointer"
                  }}>Del</button>
                </div>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Programs section */}
      <div>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
          <h3 style={{ color: "#ccd6f6", fontSize: 18, fontWeight: 700 }}>My Programs</h3>
          <button onClick={onNewProgram} style={{
            padding: "8px 16px", background: "rgba(100,255,218,0.15)",
            border: "1px solid rgba(100,255,218,0.3)", borderRadius: 10,
            color: "#64ffda", fontSize: 13, fontWeight: 700, cursor: "pointer"
          }}>+ New</button>
        </div>

        {Object.values(programs).length === 0 ? (
          <div style={{ padding: 24, textAlign: "center", color: "#8892b0", fontSize: 14, background: "rgba(255,255,255,0.02)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.06)" }}>
            No programs yet. Build routines first, then combine them into a program!
          </div>
        ) : (
          Object.values(programs).map(prog => {
            const isActive = activeSource?.type === "program" && activeSource?.programId === prog.id;
            return (
              <div key={prog.id} className="fade-in" style={{
                background: isActive ? "rgba(100,255,218,0.06)" : "rgba(255,255,255,0.04)",
                borderRadius: 14, padding: 16, marginBottom: 10,
                border: isActive ? "1px solid rgba(100,255,218,0.3)" : "1px solid rgba(255,255,255,0.06)"
              }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <span style={{ color: "#ccd6f6", fontSize: 16, fontWeight: 600 }}>{prog.name}</span>
                      {isActive && <span style={{ padding: "2px 8px", background: "#64ffda", color: "#0a192f", fontSize: 10, fontWeight: 700, borderRadius: 6 }}>ACTIVE</span>}
                    </div>
                    <div style={{ color: "#8892b0", fontSize: 13, marginTop: 4 }}>
                      {prog.weeks.length} week{prog.weeks.length !== 1 ? "s" : ""} ¬∑ {prog.weeks.reduce((sum, w) => sum + w.days.length, 0)} days
                    </div>
                  </div>
                  <div style={{ display: "flex", gap: 8, flexShrink: 0, marginLeft: 12 }}>
                    {!isActive && (
                      <button onClick={() => onActivateProgram(prog.id)} style={{
                        padding: "8px 12px", background: "rgba(100,255,218,0.15)",
                        border: "1px solid rgba(100,255,218,0.3)", borderRadius: 8,
                        color: "#64ffda", fontSize: 12, cursor: "pointer", fontWeight: 700
                      }}>Start</button>
                    )}
                    <button onClick={() => onEditProgram(prog.id)} style={{
                      padding: "8px 12px", background: "rgba(255,255,255,0.06)",
                      border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8,
                      color: "#8892b0", fontSize: 12, cursor: "pointer"
                    }}>Edit</button>
                    <button onClick={() => { if (confirm(`Delete "${prog.name}"?`)) onDeleteProgram(prog.id); }} style={{
                      padding: "8px 12px", background: "rgba(233,69,96,0.1)",
                      border: "1px solid rgba(233,69,96,0.2)", borderRadius: 8,
                      color: "#e94560", fontSize: 12, cursor: "pointer"
                    }}>Del</button>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Routine Editor ‚îÄ‚îÄ‚îÄ
function RoutineEditor({ routine, onSave, onBack }) {
  const [name, setName] = useState(routine?.name || "");
  const [exercises, setExercises] = useState(routine?.exercises || []);
  const [showSearch, setShowSearch] = useState(false);

  const handleAddExercise = (ex) => {
    setExercises([...exercises, {
      name: ex.name, sets: 3, reps: "8-12", rest: "2",
      bodyPart: ex.bodyPart, target: ex.target
    }]);
    setShowSearch(false);
  };

  const updateExercise = (idx, field, value) => {
    const updated = [...exercises];
    updated[idx] = { ...updated[idx], [field]: value };
    setExercises(updated);
  };

  const removeExercise = (idx) => {
    setExercises(exercises.filter((_, i) => i !== idx));
  };

  const moveExercise = (idx, dir) => {
    const newIdx = idx + dir;
    if (newIdx < 0 || newIdx >= exercises.length) return;
    const updated = [...exercises];
    [updated[idx], updated[newIdx]] = [updated[newIdx], updated[idx]];
    setExercises(updated);
  };

  if (showSearch) {
    return (
      <div style={{ paddingBottom: 80 }}>
        <ExerciseSearch onSelect={handleAddExercise} onBack={() => setShowSearch(false)} />
      </div>
    );
  }

  return (
    <div style={{ padding: "0 20px 80px" }}>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 24 }}>
        <button onClick={onBack} style={{ background: "none", border: "none", color: "#64ffda", fontSize: 15, cursor: "pointer", fontWeight: 600, flexShrink: 0 }}>‚Üê</button>
        <h2 style={{ color: "#ccd6f6", fontSize: 20, fontWeight: 700 }}>{routine ? "Edit Routine" : "New Routine"}</h2>
      </div>

      {/* Routine name */}
      <div style={{ marginBottom: 24 }}>
        <label style={{ display: "block", color: "#8892b0", fontSize: 11, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Routine Name</label>
        <input type="text" value={name} onChange={e => setName(e.target.value)}
          placeholder="e.g. Pull Day, Leg Day..."
          style={{
            width: "100%", padding: "14px 16px", background: "rgba(255,255,255,0.06)",
            border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12,
            color: "#ccd6f6", fontSize: 16, outline: "none", boxSizing: "border-box"
          }}
        />
      </div>

      {/* Exercise list */}
      {exercises.map((ex, i) => (
        <div key={i} className="fade-in" style={{
          background: "rgba(255,255,255,0.04)", borderRadius: 14,
          padding: 14, marginBottom: 10, border: "1px solid rgba(255,255,255,0.06)"
        }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ color: "#ccd6f6", fontSize: 15, fontWeight: 600, textTransform: "capitalize", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{ex.name}</div>
              {ex.bodyPart && <div style={{ color: "#8892b0", fontSize: 11, textTransform: "capitalize", marginTop: 2 }}>{ex.bodyPart} ¬∑ {ex.target}</div>}
            </div>
            <div style={{ display: "flex", gap: 4, flexShrink: 0 }}>
              <button onClick={() => moveExercise(i, -1)} disabled={i === 0} style={{ width: 28, height: 28, borderRadius: 6, background: "rgba(255,255,255,0.06)", border: "none", color: i === 0 ? "#333" : "#8892b0", cursor: i === 0 ? "default" : "pointer", fontSize: 12 }}>‚Üë</button>
              <button onClick={() => moveExercise(i, 1)} disabled={i === exercises.length - 1} style={{ width: 28, height: 28, borderRadius: 6, background: "rgba(255,255,255,0.06)", border: "none", color: i === exercises.length - 1 ? "#333" : "#8892b0", cursor: i === exercises.length - 1 ? "default" : "pointer", fontSize: 12 }}>‚Üì</button>
              <button onClick={() => removeExercise(i)} style={{ width: 28, height: 28, borderRadius: 6, background: "rgba(233,69,96,0.1)", border: "none", color: "#e94560", cursor: "pointer", fontSize: 12 }}>‚úï</button>
            </div>
          </div>
          <div style={{ display: "flex", gap: 8 }}>
            <div style={{ flex: 1 }}>
              <label style={{ display: "block", color: "#8892b0", fontSize: 10, letterSpacing: 1, textTransform: "uppercase", marginBottom: 4 }}>Sets</label>
              <input type="number" inputMode="numeric" value={ex.sets} onChange={e => updateExercise(i, "sets", parseInt(e.target.value) || 1)}
                style={{ width: "100%", padding: "10px 8px", background: "rgba(255,255,255,0.06)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, color: "#ccd6f6", fontSize: 16, textAlign: "center", outline: "none", fontFamily: "'JetBrains Mono',monospace" }} />
            </div>
            <div style={{ flex: 1 }}>
              <label style={{ display: "block", color: "#8892b0", fontSize: 10, letterSpacing: 1, textTransform: "uppercase", marginBottom: 4 }}>Reps</label>
              <input type="text" value={ex.reps} onChange={e => updateExercise(i, "reps", e.target.value)}
                placeholder="8-12"
                style={{ width: "100%", padding: "10px 8px", background: "rgba(255,255,255,0.06)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, color: "#ccd6f6", fontSize: 16, textAlign: "center", outline: "none", fontFamily: "'JetBrains Mono',monospace" }} />
            </div>
            <div style={{ flex: 1 }}>
              <label style={{ display: "block", color: "#8892b0", fontSize: 10, letterSpacing: 1, textTransform: "uppercase", marginBottom: 4 }}>Rest (min)</label>
              <input type="text" value={ex.rest} onChange={e => updateExercise(i, "rest", e.target.value)}
                placeholder="2"
                style={{ width: "100%", padding: "10px 8px", background: "rgba(255,255,255,0.06)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, color: "#ccd6f6", fontSize: 16, textAlign: "center", outline: "none", fontFamily: "'JetBrains Mono',monospace" }} />
            </div>
          </div>
        </div>
      ))}

      {/* Add exercise button */}
      <button onClick={() => setShowSearch(true)} style={{
        width: "100%", padding: 16, background: "rgba(255,255,255,0.04)",
        border: "2px dashed rgba(100,255,218,0.3)", borderRadius: 14,
        color: "#64ffda", fontSize: 15, fontWeight: 600, cursor: "pointer",
        marginBottom: 20
      }}>+ Add Exercise</button>

      {/* Save button */}
      <button onClick={() => {
        if (!name.trim()) { alert("Please enter a routine name"); return; }
        if (exercises.length === 0) { alert("Add at least one exercise"); return; }
        onSave({ ...routine, name: name.trim(), exercises });
      }} style={{
        width: "100%", padding: 18, background: exercises.length > 0 && name.trim() ? "#64ffda" : "rgba(100,255,218,0.3)",
        border: "none", borderRadius: 14, color: "#0a192f", fontSize: 17, fontWeight: 700,
        cursor: exercises.length > 0 && name.trim() ? "pointer" : "default", letterSpacing: 1
      }}>Save Routine</button>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Program Editor ‚îÄ‚îÄ‚îÄ
function ProgramEditor({ program, routines, onSave, onBack }) {
  const [name, setName] = useState(program?.name || "");
  const [weeks, setWeeks] = useState(program?.weeks || [{ name: "WEEK 1", days: [] }]);

  const addWeek = () => {
    setWeeks([...weeks, { name: `WEEK ${weeks.length + 1}`, days: [] }]);
  };

  const removeWeek = (idx) => {
    if (weeks.length <= 1) return;
    setWeeks(weeks.filter((_, i) => i !== idx));
  };

  const updateWeekName = (idx, newName) => {
    const updated = [...weeks];
    updated[idx] = { ...updated[idx], name: newName };
    setWeeks(updated);
  };

  const addDayToWeek = (weekIdx, routineId) => {
    const routine = routines[routineId];
    if (!routine) return;
    const updated = [...weeks];
    updated[weekIdx] = {
      ...updated[weekIdx],
      days: [...updated[weekIdx].days, { routineId, routineName: routine.name }]
    };
    setWeeks(updated);
  };

  const removeDayFromWeek = (weekIdx, dayIdx) => {
    const updated = [...weeks];
    updated[weekIdx] = {
      ...updated[weekIdx],
      days: updated[weekIdx].days.filter((_, i) => i !== dayIdx)
    };
    setWeeks(updated);
  };

  const routineList = Object.values(routines);

  return (
    <div style={{ padding: "0 20px 80px" }}>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 24 }}>
        <button onClick={onBack} style={{ background: "none", border: "none", color: "#64ffda", fontSize: 15, cursor: "pointer", fontWeight: 600, flexShrink: 0 }}>‚Üê</button>
        <h2 style={{ color: "#ccd6f6", fontSize: 20, fontWeight: 700 }}>{program ? "Edit Program" : "New Program"}</h2>
      </div>

      {/* Program name */}
      <div style={{ marginBottom: 24 }}>
        <label style={{ display: "block", color: "#8892b0", fontSize: 11, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Program Name</label>
        <input type="text" value={name} onChange={e => setName(e.target.value)}
          placeholder="e.g. 8 Week Strength Program..."
          style={{
            width: "100%", padding: "14px 16px", background: "rgba(255,255,255,0.06)",
            border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12,
            color: "#ccd6f6", fontSize: 16, outline: "none", boxSizing: "border-box"
          }}
        />
      </div>

      {routineList.length === 0 && (
        <div style={{ padding: 24, textAlign: "center", color: "#e94560", fontSize: 14, background: "rgba(233,69,96,0.08)", borderRadius: 14, border: "1px solid rgba(233,69,96,0.2)", marginBottom: 20 }}>
          Create some routines first before building a program!
        </div>
      )}

      {/* Weeks */}
      {weeks.map((week, wi) => (
        <div key={wi} style={{
          background: "rgba(255,255,255,0.04)", borderRadius: 14,
          padding: 16, marginBottom: 14, border: "1px solid rgba(255,255,255,0.06)"
        }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <input type="text" value={week.name} onChange={e => updateWeekName(wi, e.target.value)}
              style={{
                background: "transparent", border: "none", color: "#64ffda", fontSize: 15,
                fontWeight: 700, outline: "none", letterSpacing: 1
              }}
            />
            {weeks.length > 1 && (
              <button onClick={() => removeWeek(wi)} style={{ padding: "4px 10px", background: "rgba(233,69,96,0.1)", border: "none", borderRadius: 6, color: "#e94560", fontSize: 11, cursor: "pointer" }}>Remove</button>
            )}
          </div>

          {/* Days in this week */}
          {week.days.map((day, di) => (
            <div key={di} style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              padding: "10px 12px", background: "rgba(255,255,255,0.04)", borderRadius: 10,
              marginBottom: 6, border: "1px solid rgba(255,255,255,0.06)"
            }}>
              <div>
                <span style={{ color: "#8892b0", fontSize: 12, marginRight: 8 }}>Day {di + 1}</span>
                <span style={{ color: "#ccd6f6", fontSize: 14, fontWeight: 600 }}>{day.routineName}</span>
              </div>
              <button onClick={() => removeDayFromWeek(wi, di)} style={{
                width: 24, height: 24, borderRadius: 6, background: "rgba(233,69,96,0.1)",
                border: "none", color: "#e94560", cursor: "pointer", fontSize: 11
              }}>‚úï</button>
            </div>
          ))}

          {/* Add day to week */}
          {routineList.length > 0 && (
            <select onChange={e => { if (e.target.value) { addDayToWeek(wi, e.target.value); e.target.value = ""; } }} defaultValue=""
              style={{
                width: "100%", padding: "10px 12px", background: "rgba(255,255,255,0.04)",
                border: "1px dashed rgba(100,255,218,0.3)", borderRadius: 10,
                color: "#64ffda", fontSize: 13, cursor: "pointer", outline: "none", marginTop: 4
              }}>
              <option value="" disabled>+ Add routine to this week...</option>
              {routineList.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
            </select>
          )}
        </div>
      ))}

      {/* Add week */}
      <button onClick={addWeek} style={{
        width: "100%", padding: 14, background: "rgba(255,255,255,0.04)",
        border: "2px dashed rgba(255,255,255,0.12)", borderRadius: 14,
        color: "#8892b0", fontSize: 14, fontWeight: 600, cursor: "pointer", marginBottom: 20
      }}>+ Add Week</button>

      {/* Save */}
      <button onClick={() => {
        if (!name.trim()) { alert("Please enter a program name"); return; }
        if (weeks.every(w => w.days.length === 0)) { alert("Add at least one day to a week"); return; }
        onSave({ ...program, name: name.trim(), weeks });
      }} style={{
        width: "100%", padding: 18,
        background: name.trim() && weeks.some(w => w.days.length > 0) ? "#64ffda" : "rgba(100,255,218,0.3)",
        border: "none", borderRadius: 14, color: "#0a192f", fontSize: 17, fontWeight: 700,
        cursor: name.trim() && weeks.some(w => w.days.length > 0) ? "pointer" : "default", letterSpacing: 1
      }}>Save Program</button>
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Main App
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function App() {
  const [plan, setPlan] = useState(null); // { "WEEK 1": [{name, exercises}], ... }
  const [weekIdx, setWeekIdx] = useState(0);
  const [dayIdx, setDayIdx] = useState(0);
  const [exIdx, setExIdx] = useState(0);
  const [logged, setLogged] = useState({}); // "W0|D0|ExName" -> ["135√ó8", ...]
  const [history, setHistory] = useState({}); // "ExName" -> [{week, day, sets}]
  const [timer, setTimer] = useState(false);
  const [timerLen, setTimerLen] = useState(60);
  const [defTimer, setDefTimer] = useState(60);
  const [started, setStarted] = useState(false);
  const [complete, setComplete] = useState(false);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);
  const [settings, setSettings] = useState(false);
  const [view, setView] = useState("workout"); // workout | overview
  const [editingSet, setEditingSet] = useState(null); // index of set being edited, or null

  // Builder state
  const [tab, setTab] = useState("workout"); // workout | build
  const [buildView, setBuildView] = useState("home"); // home | search | editRoutine | editProgram
  const [routines, setRoutines] = useState({}); // { id: { id, name, exercises } }
  const [programs, setPrograms] = useState({}); // { id: { id, name, weeks } }
  const [activeSource, setActiveSource] = useState({ type: "sheets" });
  const [activeWeeks, setActiveWeeks] = useState(WEEKS);
  const [editingRoutineId, setEditingRoutineId] = useState(null);
  const [editingProgramId, setEditingProgramId] = useState(null);

  const saveRoutines = useCallback(async (r) => { setRoutines(r); await dbSet("routines", r); }, []);
  const savePrograms = useCallback(async (p) => { setPrograms(p); await dbSet("programs", p); }, []);
  const saveActiveSource = useCallback(async (s) => { setActiveSource(s); await dbSet("activeSource", s); }, []);

  function resolveProgram(program, rts) {
    const resolved = {};
    program.weeks.forEach((week, i) => {
      const weekName = week.name || `WEEK ${i + 1}`;
      resolved[weekName] = week.days.map(day => {
        const routine = rts[day.routineId];
        if (!routine) return { name: day.routineName || "Unknown", exercises: [] };
        return { name: routine.name, exercises: routine.exercises.map(ex => ({
          name: ex.name, sets: ex.sets || 3, reps: ex.reps || "8-12", rest: ex.rest || "2"
        }))};
      });
    });
    return resolved;
  }

  async function activateProgram(progId) {
    const prog = programs[progId];
    if (!prog) return;
    const resolved = resolveProgram(prog, routines);
    const weekNames = Object.keys(resolved);
    setPlan(resolved);
    setActiveWeeks(weekNames);
    setWeekIdx(0); setDayIdx(0); setExIdx(0);
    setStarted(false); setComplete(false);
    await saveActiveSource({ type: "program", programId: progId });
    await save(0, 0, defTimer);
    setTab("workout");
  }

  async function activateSheets() {
    try {
      const freshPlan = await fetchAllWeeks();
      setPlan(freshPlan);
      await dbSet("plan", freshPlan);
    } catch (e) {
      const cached = await dbGet("plan");
      if (cached) setPlan(cached);
    }
    setActiveWeeks(WEEKS);
    setWeekIdx(0); setDayIdx(0); setExIdx(0);
    setStarted(false); setComplete(false);
    await saveActiveSource({ type: "sheets" });
    await save(0, 0, defTimer);
  }

  // ‚îÄ‚îÄ‚îÄ Init: load from IDB, then fetch plan ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    (async () => {
      try {
        // Load saved state
        const [savedState, savedLogged, savedHistory, savedPlan, savedRoutines, savedPrograms, savedSource] = await Promise.all([
          dbGet("state"), dbGet("logged"), dbGet("history"), dbGet("plan"),
          dbGet("routines"), dbGet("programs"), dbGet("activeSource")
        ]);
        if (savedState) {
          setWeekIdx(savedState.weekIdx ?? 0);
          setDayIdx(savedState.dayIdx ?? 0);
          setDefTimer(savedState.defTimer ?? 60);
        }
        if (savedLogged) setLogged(savedLogged);
        if (savedHistory) setHistory(savedHistory);
        if (savedRoutines) setRoutines(savedRoutines);
        if (savedPrograms) setPrograms(savedPrograms);
        if (savedSource) setActiveSource(savedSource);

        // Load plan based on active source
        const src = savedSource || { type: "sheets" };
        if (src.type === "program" && savedPrograms && savedRoutines && savedPrograms[src.programId]) {
          const resolved = resolveProgram(savedPrograms[src.programId], savedRoutines);
          setPlan(resolved);
          setActiveWeeks(Object.keys(resolved));
        } else {
          // Try fetching fresh plan from sheet
          try {
            const freshPlan = await fetchAllWeeks();
            setPlan(freshPlan);
            await dbSet("plan", freshPlan);
          } catch (e) {
            // Offline - use cached plan
            if (savedPlan) {
              setPlan(savedPlan);
            } else {
              throw new Error("No cached data and can't reach Google Sheets. Please connect to the internet for initial setup.");
            }
          }
        }
        setLoading(false);
      } catch (e) {
        setErr(e.message);
        setLoading(false);
      }
    })();
  }, []);

  // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
  const save = useCallback(async (wk, dy, tmr) => {
    await dbSet("state", { weekIdx: wk, dayIdx: dy, defTimer: tmr });
  }, []);

  const saveLogs = useCallback(async (l) => { setLogged(l); await dbSet("logged", l); }, []);
  const saveHist = useCallback(async (h) => { setHistory(h); await dbSet("history", h); }, []);

  const curWeek = plan ? plan[activeWeeks[weekIdx]] : null;
  const curDay = curWeek?.[dayIdx];
  const curEx = curDay?.exercises[exIdx];
  const logKey = (w, d, name) => `W${w}|D${d}|${name}`;
  const curKey = curEx ? logKey(weekIdx, dayIdx, curEx.name) : "";
  const curLogs = logged[curKey] || [];

  const getRestSec = (r) => {
    if (!r) return defTimer;
    const m = r.match(/(\d+)/);
    return m ? parseInt(m[1]) * 60 : defTimer;
  };

  const advanceEx = () => {
    setEditingSet(null);
    if (exIdx < curDay.exercises.length - 1) {
      setExIdx(exIdx + 1);
      setTimer(false);
    } else {
      setComplete(true);
      setTimer(false);
    }
  };

  const handleLog = (entry) => {
    const newLogs = [...curLogs, entry];
    const newAll = { ...logged, [curKey]: newLogs };
    saveLogs(newAll);
    setEditingSet(null);
    setTimerLen(getRestSec(curEx.rest));
    setTimer(true);
  };

  const handleTimerDone = useCallback(() => {
    setTimer(false);
    // Check if exercise is complete and auto-advance
    const key = curEx ? logKey(weekIdx, dayIdx, curEx.name) : "";
    const logs = logged[key] || [];
    // Need to check with the potentially updated logged state
    // Since handleLog updates logged before starting timer, logs should reflect the new set
  }, [curEx, weekIdx, dayIdx, logged]);

  // After timer, check if we should auto-advance
  useEffect(() => {
    if (!timer && curEx && started && !complete) {
      const logs = logged[curKey] || [];
      if (logs.length >= curEx.sets) {
        advanceEx();
      }
    }
  }, [timer]);

  const handleFinish = async () => {
    const newHist = { ...history };
    for (const ex of curDay.exercises) {
      const k = logKey(weekIdx, dayIdx, ex.name);
      const sets = logged[k] || [];
      if (sets.length > 0) {
        if (!newHist[ex.name]) newHist[ex.name] = [];
        newHist[ex.name].push({ week: activeWeeks[weekIdx], day: dayIdx, sets: [...sets] });
      }
    }
    await saveHist(newHist);

    // Clear logged sets for this day's exercises
    const newLogged = { ...logged };
    for (const ex of curDay.exercises) {
      delete newLogged[logKey(weekIdx, dayIdx, ex.name)];
    }
    await saveLogs(newLogged);

    // Advance day
    let nw = weekIdx, nd = dayIdx + 1;
    if (nd >= curWeek.length) { nd = 0; nw = Math.min(weekIdx + 1, activeWeeks.length - 1); }
    setWeekIdx(nw); setDayIdx(nd); setExIdx(0);
    setComplete(false); setStarted(false);
    await save(nw, nd, defTimer);
  };

  const skipDay = async () => {
    let nw = weekIdx, nd = dayIdx + 1;
    if (nd >= curWeek.length) { nd = 0; nw = Math.min(weekIdx + 1, activeWeeks.length - 1); }
    setWeekIdx(nw); setDayIdx(nd); setExIdx(0);
    setComplete(false); setStarted(false); setTimer(false);
    await save(nw, nd, defTimer);
  };

  // ‚îÄ‚îÄ‚îÄ Loading / Error ‚îÄ‚îÄ‚îÄ
  if (loading) return (
    <div style={{ minHeight: "100dvh", display: "flex", alignItems: "center", justifyContent: "center", background: "#0a192f", color: "#64ffda" }}>
      <div style={{ textAlign: "center" }}>
        <div style={{ fontSize: 48, marginBottom: 16 }}>üèãÔ∏è</div>
        <div style={{ fontSize: 13, letterSpacing: 3, textTransform: "uppercase", fontFamily: "'JetBrains Mono',monospace", animation: "pulse 1.5s infinite" }}>
          Loading Workout Plan...
        </div>
      </div>
    </div>
  );

  if (err) return (
    <div style={{ minHeight: "100dvh", display: "flex", alignItems: "center", justifyContent: "center", background: "#0a192f", color: "#e94560", padding: 24 }}>
      <div style={{ textAlign: "center", maxWidth: 360 }}>
        <div style={{ fontSize: 48, marginBottom: 16 }}>‚ö†Ô∏è</div>
        <div style={{ fontSize: 15, lineHeight: 1.6 }}>{err}</div>
      </div>
    </div>
  );

  const cs = {
    minHeight: "100dvh", background: "#0a192f", color: "#ccd6f6",
    maxWidth: 480, margin: "0 auto", paddingBottom: 80
  };

  // ‚îÄ‚îÄ‚îÄ Build Tab ‚îÄ‚îÄ‚îÄ
  if (tab === "build") return (
    <div style={cs}>
      <div style={{ padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
        <div style={{ color: "#64ffda", fontSize: 11, letterSpacing: 2, textTransform: "uppercase", fontWeight: 700 }}>
          {buildView === "home" ? "Workout Builder" : buildView === "search" ? "Exercise Search" : buildView === "editRoutine" ? "Routine Editor" : "Program Editor"}
        </div>
        {activeSource.type === "program" && buildView === "home" && (
          <button onClick={activateSheets} style={{
            padding: "6px 12px", background: "rgba(255,255,255,0.06)",
            border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8,
            color: "#8892b0", fontSize: 11, cursor: "pointer"
          }}>Use Sheet Plan</button>
        )}
      </div>

      <div style={{ padding: "20px 0 0" }}>
        {buildView === "home" && (
          <BuilderHome
            routines={routines} programs={programs} activeSource={activeSource}
            onSearch={() => setBuildView("search")}
            onNewRoutine={() => { setEditingRoutineId(null); setBuildView("editRoutine"); }}
            onEditRoutine={(id) => { setEditingRoutineId(id); setBuildView("editRoutine"); }}
            onDeleteRoutine={async (id) => { const r = { ...routines }; delete r[id]; await saveRoutines(r); }}
            onNewProgram={() => { setEditingProgramId(null); setBuildView("editProgram"); }}
            onEditProgram={(id) => { setEditingProgramId(id); setBuildView("editProgram"); }}
            onDeleteProgram={async (id) => {
              const p = { ...programs }; delete p[id]; await savePrograms(p);
              if (activeSource.type === "program" && activeSource.programId === id) await activateSheets();
            }}
            onActivateProgram={activateProgram}
          />
        )}
        {buildView === "search" && (
          <ExerciseSearch onBack={() => setBuildView("home")} />
        )}
        {buildView === "editRoutine" && (
          <RoutineEditor
            routine={editingRoutineId ? routines[editingRoutineId] : null}
            onSave={async (routine) => {
              const id = routine.id || Date.now().toString();
              const r = { ...routines, [id]: { ...routine, id } };
              await saveRoutines(r); setBuildView("home");
            }}
            onBack={() => setBuildView("home")}
          />
        )}
        {buildView === "editProgram" && (
          <ProgramEditor
            program={editingProgramId ? programs[editingProgramId] : null}
            routines={routines}
            onSave={async (program) => {
              const id = program.id || Date.now().toString();
              const p = { ...programs, [id]: { ...program, id } };
              await savePrograms(p); setBuildView("home");
            }}
            onBack={() => setBuildView("home")}
          />
        )}
      </div>

      <BottomNav tab={tab} onTabChange={setTab} />
    </div>
  );

  // ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ
  if (settings) return (
    <div style={cs}>
      <div style={{ padding: "20px 20px 0" }}>
        <button onClick={() => setSettings(false)} style={{ background: "none", border: "none", color: "#64ffda", fontSize: 15, cursor: "pointer", fontWeight: 600 }}>‚Üê Back</button>
      </div>
      <div style={{ padding: 20 }}>
        <h2 style={{ color: "#ccd6f6", fontSize: 22, fontWeight: 700, marginBottom: 28 }}>Settings</h2>

        <div style={{ marginBottom: 28 }}>
          <label style={{ display: "block", color: "#8892b0", fontSize: 12, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Default Rest Timer (sec)</label>
          <input type="number" value={defTimer} onChange={e => { const v = parseInt(e.target.value) || 60; setDefTimer(v); save(weekIdx, dayIdx, v); }}
            style={{ width: "100%", padding: 14, background: "rgba(255,255,255,0.06)", border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12, color: "#ccd6f6", fontSize: 20, outline: "none", fontFamily: "'JetBrains Mono',monospace", textAlign: "center" }} />
        </div>

        <div style={{ marginBottom: 28 }}>
          <label style={{ display: "block", color: "#8892b0", fontSize: 12, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Current Week</label>
          <select value={weekIdx} onChange={e => { const i = parseInt(e.target.value); setWeekIdx(i); setDayIdx(0); setExIdx(0); setStarted(false); setComplete(false); save(i, 0, defTimer); }}
            style={{ width: "100%", padding: 14, background: "rgba(255,255,255,0.06)", border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12, color: "#ccd6f6", fontSize: 16, outline: "none" }}>
            {activeWeeks.map((w, i) => <option key={w} value={i}>{w}</option>)}
          </select>
        </div>

        <div style={{ marginBottom: 28 }}>
          <label style={{ display: "block", color: "#8892b0", fontSize: 12, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Current Day</label>
          <select value={dayIdx} onChange={e => { const i = parseInt(e.target.value); setDayIdx(i); setExIdx(0); setStarted(false); setComplete(false); save(weekIdx, i, defTimer); }}
            style={{ width: "100%", padding: 14, background: "rgba(255,255,255,0.06)", border: "2px solid rgba(255,255,255,0.12)", borderRadius: 12, color: "#ccd6f6", fontSize: 16, outline: "none" }}>
            {curWeek?.map((d, i) => <option key={i} value={i}>{d.name}</option>)}
          </select>
        </div>

        <div style={{ background: "rgba(233,69,96,0.08)", border: "1px solid rgba(233,69,96,0.25)", borderRadius: 14, padding: 20, marginTop: 40 }}>
          <div style={{ color: "#e94560", fontWeight: 700, fontSize: 14, marginBottom: 10 }}>Danger Zone</div>
          <button onClick={async () => {
            if (confirm("Clear ALL logged workout data and history? This cannot be undone.")) {
              await dbSet("logged", {});
              await dbSet("history", {});
              setLogged({}); setHistory({});
            }
          }} style={{
            padding: "12px 24px", background: "rgba(233,69,96,0.15)", border: "1px solid #e94560",
            borderRadius: 10, color: "#e94560", fontSize: 14, cursor: "pointer", fontWeight: 600
          }}>Clear All History</button>
        </div>
      </div>
    </div>
  );

  // ‚îÄ‚îÄ‚îÄ Overview ‚îÄ‚îÄ‚îÄ
  if (view === "overview") return (
    <div style={cs}>
      <div style={{ padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
        <button onClick={() => setView("workout")} style={{ background: "none", border: "none", color: "#64ffda", fontSize: 15, cursor: "pointer", fontWeight: 600 }}>‚Üê Back</button>
        <span style={{ color: "#8892b0", fontSize: 13 }}>{activeWeeks[weekIdx]}</span>
      </div>
      <div style={{ padding: 20 }}>
        <h2 style={{ color: "#ccd6f6", fontSize: 21, fontWeight: 700, marginBottom: 20 }}>{curDay?.name}</h2>
        {curDay?.exercises.map((ex, i) => {
          const k = logKey(weekIdx, dayIdx, ex.name);
          const logs = logged[k] || [];
          const done = logs.length >= ex.sets;
          return (
            <div key={i} className="fade-in" style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              padding: "14px 0", borderBottom: "1px solid rgba(255,255,255,0.06)",
              opacity: done ? 0.5 : 1, animationDelay: `${i * 40}ms`
            }}>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ fontWeight: 600, fontSize: 15 }}>{done ? "‚úÖ " : ""}{ex.name}</div>
                <div style={{ color: "#8892b0", fontSize: 12, marginTop: 3 }}>{ex.sets} √ó {ex.reps} ¬∑ {ex.rest}min rest</div>
                {logs.length > 0 && <div style={{ color: "#64ffda", fontSize: 12, marginTop: 4, fontFamily: "'JetBrains Mono',monospace", overflow: "hidden", textOverflow: "ellipsis" }}>{logs.join(" / ")}</div>}
              </div>
              <button onClick={() => { setExIdx(i); setStarted(true); setView("workout"); }}
                style={{ background: done ? "rgba(255,255,255,0.04)" : "rgba(100,255,218,0.1)", border: done ? "1px solid rgba(255,255,255,0.1)" : "1px solid rgba(100,255,218,0.3)", borderRadius: 10, padding: "10px 16px", color: done ? "#8892b0" : "#64ffda", fontSize: 13, cursor: "pointer", fontWeight: 600, flexShrink: 0, marginLeft: 12 }}>
                {done ? "Redo" : "Go ‚Üí"}
              </button>
            </div>
          );
        })}
      </div>
      <BottomNav tab={tab} onTabChange={setTab} />
    </div>
  );

  // ‚îÄ‚îÄ‚îÄ Workout Complete ‚îÄ‚îÄ‚îÄ
  if (complete) return (
    <div style={cs}>
      <div className="fade-in" style={{ padding: "50px 24px", textAlign: "center" }}>
        <div style={{ fontSize: 64, marginBottom: 16 }}>üí™</div>
        <h2 style={{ color: "#64ffda", fontSize: 24, fontWeight: 700, marginBottom: 8 }}>Workout Complete!</h2>
        <p style={{ color: "#8892b0", fontSize: 14, marginBottom: 28 }}>{curDay?.name} ‚Äî {activeWeeks[weekIdx]}</p>
        <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 16, padding: 20, textAlign: "left", marginBottom: 28 }}>
          {curDay?.exercises.map((ex, i) => {
            const logs = logged[logKey(weekIdx, dayIdx, ex.name)] || [];
            return (
              <div key={i} style={{ padding: "10px 0", borderBottom: i < curDay.exercises.length - 1 ? "1px solid rgba(255,255,255,0.06)" : "none" }}>
                <div style={{ fontWeight: 600, fontSize: 14, marginBottom: 4 }}>{ex.name}</div>
                <div style={{ color: "#64ffda", fontSize: 13, fontFamily: "'JetBrains Mono',monospace" }}>{logs.join(" / ") || "‚Äî skipped"}</div>
              </div>
            );
          })}
        </div>
        <button onClick={handleFinish} style={{ width: "100%", padding: 18, background: "#64ffda", border: "none", borderRadius: 14, color: "#0a192f", fontSize: 17, fontWeight: 700, cursor: "pointer", letterSpacing: 1 }}>
          Save & Next Day ‚Üí
        </button>
        <button onClick={() => { setComplete(false); setView("overview"); }} style={{ width: "100%", padding: 14, background: "transparent", border: "1px solid rgba(255,255,255,0.15)", borderRadius: 14, color: "#8892b0", fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: 10 }}>
          Review Exercises
        </button>
      </div>
      <BottomNav tab={tab} onTabChange={setTab} />
    </div>
  );

  // ‚îÄ‚îÄ‚îÄ Start Screen ‚îÄ‚îÄ‚îÄ
  if (!started) return (
    <div style={cs}>
      <div style={{ padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
        <div style={{ color: "#64ffda", fontSize: 11, letterSpacing: 2, textTransform: "uppercase", fontWeight: 700 }}>
          {activeSource.type === "program" && programs[activeSource.programId] ? programs[activeSource.programId].name : "Hybrid PPL"}
        </div>
        <button onClick={() => setSettings(true)} style={{ background: "rgba(255,255,255,0.06)", border: "none", borderRadius: 8, padding: "8px 14px", color: "#8892b0", cursor: "pointer", fontSize: 16 }}>‚öôÔ∏è</button>
      </div>
      <div style={{ padding: "28px 20px" }}>
        {/* Week pills */}
        <div style={{ display: "flex", gap: 6, marginBottom: 24, flexWrap: "wrap" }}>
          {activeWeeks.map((w, i) => (
            <div key={w} style={{
              padding: "6px 12px", borderRadius: 20, fontSize: 11, fontWeight: 700, letterSpacing: 1,
              background: i === weekIdx ? "#64ffda" : "rgba(255,255,255,0.06)",
              color: i === weekIdx ? "#0a192f" : i < weekIdx ? "#64ffda" : "#8892b0",
              border: i < weekIdx ? "1px solid rgba(100,255,218,0.3)" : "1px solid transparent",
              cursor: "pointer"
            }} onClick={() => { setWeekIdx(i); setDayIdx(0); setExIdx(0); save(i, 0, defTimer); }}>
              {w.replace("WEEK ", "W")}
            </div>
          ))}
        </div>

        {/* Day card */}
        <div className="fade-in" style={{
          background: "linear-gradient(135deg,#112240,#0f3460)", borderRadius: 20,
          padding: 28, marginBottom: 20, border: "1px solid rgba(100,255,218,0.15)"
        }}>
          <div style={{ color: "#8892b0", fontSize: 12, letterSpacing: 2, textTransform: "uppercase", marginBottom: 8 }}>Up Next</div>
          <h1 style={{ color: "#ccd6f6", fontSize: 26, fontWeight: 800, marginBottom: 4, lineHeight: 1.2 }}>{curDay?.name}</h1>
          <div style={{ color: "#8892b0", fontSize: 14, marginBottom: 20 }}>{curDay?.exercises.length} exercises ¬∑ {activeWeeks[weekIdx]}</div>

          {curDay?.exercises.map((ex, i) => (
            <div key={i} style={{ display: "flex", justifyContent: "space-between", padding: "9px 0", borderBottom: i < curDay.exercises.length - 1 ? "1px solid rgba(255,255,255,0.06)" : "none" }}>
              <span style={{ color: "#ccd6f6", fontSize: 14 }}>{ex.name}</span>
              <span style={{ color: "#8892b0", fontSize: 13 }}>{ex.sets} √ó {ex.reps}</span>
            </div>
          ))}

          <button onClick={() => { requestNotificationPermission(); setStarted(true); }} style={{
            width: "100%", padding: 18, background: "#64ffda", border: "none", borderRadius: 14,
            color: "#0a192f", fontSize: 17, fontWeight: 700, cursor: "pointer", letterSpacing: 1, marginTop: 20
          }}>Start Workout üèãÔ∏è</button>
        </div>

        <button onClick={skipDay} style={{ width: "100%", padding: 14, background: "transparent", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 14, color: "#8892b0", fontSize: 14, fontWeight: 600, cursor: "pointer" }}>
          Skip This Day ‚Üí
        </button>
      </div>
      <BottomNav tab={tab} onTabChange={setTab} />
    </div>
  );

  // ‚îÄ‚îÄ‚îÄ Active Workout ‚îÄ‚îÄ‚îÄ
  const exProgress = curDay?.exercises.map((ex, i) => (logged[logKey(weekIdx, dayIdx, ex.name)] || []).length >= ex.sets) || [];
  const doneCount = exProgress.filter(Boolean).length;
  const totalEx = curDay?.exercises.length || 0;

  return (
    <div style={cs}>
      {/* Sticky header */}
      <div style={{ padding: "12px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: "1px solid rgba(255,255,255,0.06)", position: "sticky", top: 0, background: "#0a192f", zIndex: 10 }}>
        <button onClick={() => setView("overview")} style={{ background: "none", border: "none", color: "#8892b0", fontSize: 14, cursor: "pointer", fontWeight: 600 }}>‚ò∞ All</button>
        <div style={{ color: "#8892b0", fontSize: 12, fontWeight: 600 }}>{curDay?.name}</div>
        <div style={{ color: "#64ffda", fontSize: 12, fontWeight: 700 }}>{doneCount}/{totalEx}</div>
      </div>

      {/* Progress dots */}
      <div style={{ display: "flex", gap: 4, padding: "12px 20px", justifyContent: "center" }}>
        {curDay?.exercises.map((_, i) => (
          <div key={i} onClick={() => { setExIdx(i); setTimer(false); setEditingSet(null); }} style={{
            width: i === exIdx ? 24 : 8, height: 8, borderRadius: 4, cursor: "pointer",
            background: exProgress[i] ? "#64ffda" : i === exIdx ? "#e94560" : "rgba(255,255,255,0.1)",
            transition: "all 0.3s ease"
          }} />
        ))}
      </div>

      <div style={{ padding: "8px 20px 20px" }}>
        {curEx && (
          <div className="fade-in" key={exIdx}>
            {/* Exercise header */}
            <div style={{ marginBottom: 20 }}>
              <div style={{ color: "#8892b0", fontSize: 11, letterSpacing: 2, textTransform: "uppercase", marginBottom: 6 }}>
                Exercise {exIdx + 1} of {totalEx}
              </div>
              <h2 style={{ color: "#ccd6f6", fontSize: 28, fontWeight: 800, lineHeight: 1.2, marginBottom: 10 }}>
                {curEx.name}
              </h2>
              <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
                <Pill color="green" value={curEx.reps} label="reps" />
                <Pill color="red" value={curEx.sets} label="sets" />
                <Pill color="gray" value={curEx.rest} label="min rest" />
              </div>
            </div>

            {/* Logged sets */}
            {curLogs.length > 0 && (
              <div style={{ marginBottom: 16 }}>
                <div style={{ color: "#8892b0", fontSize: 11, letterSpacing: 1, textTransform: "uppercase", marginBottom: 8 }}>Today<span style={{ color: "rgba(255,255,255,0.2)", fontSize: 10, marginLeft: 8 }}>tap to edit</span></div>
                <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {curLogs.map((entry, i) => (
                    editingSet === i ? (
                      <EditSetInput key={i} setIndex={i} entry={entry} onSave={(newEntry) => {
                        const newLogs = [...curLogs];
                        newLogs[i] = newEntry;
                        saveLogs({ ...logged, [curKey]: newLogs });
                        setEditingSet(null);
                      }} onCancel={() => setEditingSet(null)} />
                    ) : (
                      <div key={i} onClick={() => setEditingSet(i)} style={{ background: "rgba(100,255,218,0.1)", border: "1px solid rgba(100,255,218,0.2)", borderRadius: 10, padding: "8px 14px", cursor: "pointer" }}>
                        <div style={{ color: "#64ffda", fontSize: 11, fontWeight: 700 }}>Set {i + 1}</div>
                        <div style={{ color: "#ccd6f6", fontSize: 15, fontWeight: 600, fontFamily: "'JetBrains Mono',monospace" }}>{entry}</div>
                      </div>
                    )
                  ))}
                </div>
              </div>
            )}

            {/* Timer / Input / Done */}
            {timer ? (
              <React.Fragment>
                <RestTimer duration={timerLen} onComplete={handleTimerDone}
                  onCancel={() => { setTimer(false); if (curLogs.length >= curEx.sets) advanceEx(); }} />
                {curLogs.length >= curEx.sets && exIdx < curDay.exercises.length - 1 && (() => {
                  const next = curDay.exercises[exIdx + 1];
                  const nextHist = history[next.name];
                  const lastSession = nextHist?.[nextHist.length - 1];
                  return (
                    <div className="fade-in" style={{
                      background: "linear-gradient(135deg,#112240,#0f3460)", borderRadius: 16,
                      padding: 20, marginTop: 16, border: "1px solid rgba(100,255,218,0.15)"
                    }}>
                      <div style={{ color: "#64ffda", fontSize: 11, fontWeight: 700, letterSpacing: 2, textTransform: "uppercase", marginBottom: 10 }}>
                        Up Next
                      </div>
                      <div style={{ color: "#ccd6f6", fontSize: 20, fontWeight: 700, marginBottom: 8 }}>{next.name}</div>
                      <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
                        <Pill color="green" value={next.reps} label="reps" />
                        <Pill color="red" value={next.sets} label="sets" />
                        <Pill color="gray" value={next.rest} label="min rest" />
                      </div>
                      {lastSession && (
                        <div style={{ marginTop: 12, padding: "10px 14px", background: "rgba(255,255,255,0.04)", borderRadius: 10 }}>
                          <div style={{ color: "#8892b0", fontSize: 11, letterSpacing: 1, textTransform: "uppercase", marginBottom: 4 }}>Last Session</div>
                          <div style={{ color: "#ccd6f6", fontSize: 13, fontFamily: "'JetBrains Mono',monospace" }}>{lastSession.sets.join(" / ")}</div>
                        </div>
                      )}
                    </div>
                  );
                })()}
              </React.Fragment>
            ) : curLogs.length < curEx.sets ? (
              <SetInput setNumber={curLogs.length + 1} exercise={curEx} onSubmit={handleLog} lastEntry={curLogs.length > 0 ? curLogs[curLogs.length - 1] : null} />
            ) : (
              <div className="fade-in" style={{ textAlign: "center", padding: 24 }}>
                <div style={{ color: "#64ffda", fontSize: 18, fontWeight: 700, marginBottom: 14 }}>‚úÖ All sets complete!</div>
                <button onClick={advanceEx} style={{ padding: "14px 32px", background: "#64ffda", border: "none", borderRadius: 12, color: "#0a192f", fontSize: 16, fontWeight: 700, cursor: "pointer" }}>
                  Next Exercise ‚Üí
                </button>
              </div>
            )}

            {/* History */}
            <ExerciseHistory history={history[curEx.name]} />
            <ExerciseChart history={history[curEx.name]} />

            {/* Nav */}
            <div style={{ display: "flex", gap: 10, marginTop: 20 }}>
              <button onClick={() => { if (exIdx > 0) { setExIdx(exIdx - 1); setTimer(false); setEditingSet(null); } }} disabled={exIdx === 0}
                style={{ flex: 1, padding: 14, background: "rgba(255,255,255,0.04)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 12, color: exIdx === 0 ? "#333" : "#8892b0", fontSize: 14, cursor: exIdx === 0 ? "default" : "pointer", fontWeight: 600 }}>
                ‚Üê Prev
              </button>
              <button onClick={advanceEx}
                style={{ flex: 1, padding: 14, background: "rgba(255,255,255,0.04)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 12, color: "#8892b0", fontSize: 14, cursor: "pointer", fontWeight: 600 }}>
                Skip ‚Üí
              </button>
            </div>
          </div>
        )}
      </div>
      <BottomNav tab={tab} onTabChange={setTab} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
<script>
// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
